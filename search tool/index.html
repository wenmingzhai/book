<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文明宅的空间搜索工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .search-shadow {
                box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 12px 20px -8px rgba(59, 130, 246, 0.2);
            }
            .highlight {
                background-color: rgba(255, 251, 0, 0.3);
                padding: 0 2px;
                border-radius: 2px;
            }
            .link-text {
                color: #3b82f6;
                text-decoration: underline;
            }
            .link-text:hover {
                color: #2563eb;
                text-decoration: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-link text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-gray-800">文明宅的空间搜索工具</h1>
            </div>
            <div class="text-sm text-gray-600">
                <span id="data-count" class="flex items-center">
                    <i class="fa fa-spinner fa-spin text-primary mr-2"></i>正在加载数据...
                </span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 搜索区域 -->
        <section class="mb-8">
            <div class="relative max-w-2xl mx-auto">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="输入关键词进行搜索..." 
                    class="w-full py-3 px-5 pr-12 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none search-shadow transition-all"
                    disabled
                >
                <button 
                    id="search-btn" 
                    class="absolute right-3 top-1/2 -translate-y-1/2 bg-gray-300 text-white p-2 rounded-lg transition-colors cursor-not-allowed"
                    disabled
                >
                    <i class="fa fa-search"></i>
                </button>
            </div>
            <p id="search-tip" class="text-center text-gray-500 mt-2 text-sm">正在加载数据，请稍候...</p>
        </section>

        <!-- 结果展示区域 -->
        <section id="results-section" class="hidden">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-search-results text-primary mr-2"></i>搜索结果
                <span id="result-count" class="ml-2 text-sm bg-gray-100 text-gray-700 py-1 px-3 rounded-full"></span>
            </h2>
            <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- 搜索结果会动态生成在这里 -->
            </div>
            <div id="no-results" class="hidden text-center py-12">
                <i class="fa fa-search-minus text-5xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">未找到匹配的关键词，请尝试其他关键词</p>
            </div>
        </section>

        <!-- 加载失败提示 -->
        <section id="load-error" class="hidden text-center py-8">
            <i class="fa fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
            <p class="text-red-600 font-medium mb-2">数据加载失败</p>
            <p class="text-gray-500" id="error-detail"></p>
            <button id="reload-btn" class="mt-4 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                <i class="fa fa-refresh mr-2"></i>重新加载
            </button>
        </section>
    </main>

    <footer class="mt-auto bg-white border-t border-gray-200 py-6">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>文明宅的空间搜索工具 &copy; 2025</p>
        </div>
    </footer>

    <script>
        // 全局变量
        let excelData = [];
        const EXCEL_FILE_PATH = 'data.xlsx'; // 确保和实际文件名一致

        // DOM元素
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const resultsSection = document.getElementById('results-section');
        const resultsContainer = document.getElementById('results-container');
        const resultCount = document.getElementById('result-count');
        const noResults = document.getElementById('no-results');
        const dataCount = document.getElementById('data-count');
        const searchTip = document.getElementById('search-tip');
        const loadError = document.getElementById('load-error');
        const errorDetail = document.getElementById('error-detail');
        const reloadBtn = document.getElementById('reload-btn');

        // 工具函数1：判断是否为纯链接
        function isValidUrl(str) {
            if (!str) return false;
            const urlPattern = /^https?:\/\/[^\s]+$/i;
            return urlPattern.test(str.trim());
        }

        // 工具函数2：文本转可点击链接（简化版，避免正则异常）
        function textToClickableLinks(text) {
            if (!text) return '';
            const str = text.toString().trim();
            
            // 如果是纯链接，直接返回a标签
            if (isValidUrl(str)) {
                const displayText = str.length > 50 ? str.substring(0, 50) + '...' : str;
                return `<a href="${str}" target="_blank" rel="noopener noreferrer" class="link-text">${displayText}</a>`;
            }

            // 混合文本中的链接，提取并转换
            const urlRegex = /(https?:\/\/[^\s,，。；;！!？?]+)/gi;
            return str.replace(urlRegex, (url) => {
                const displayText = url.length > 40 ? url.substring(0, 40) + '...' : url;
                return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="link-text">${displayText}</a>`;
            });
        }

        // 工具函数3：高亮关键词（简化版，只处理纯文本）
        function highlightKeyword(text, keyword) {
            if (!text || !keyword) return text;
            const lowerText = text.toString().toLowerCase();
            const lowerKeyword = keyword.toLowerCase();
            if (!lowerText.includes(lowerKeyword)) return text;
            
            // 简单高亮，避免破坏HTML标签
            return text.toString().replace(new RegExp(`(${keyword})`, 'gi'), '<span class="highlight">$1</span>');
        }

        // 加载Excel数据
        async function loadExcelData() {
            try {
                // 重置状态
                dataCount.innerHTML = `<i class="fa fa-spinner fa-spin text-primary mr-2"></i>正在加载数据...`;
                searchTip.textContent = '正在加载数据，请稍候...';
                loadError.classList.add('hidden');
                searchInput.disabled = true;
                searchBtn.disabled = true;
                searchBtn.className = 'absolute right-3 top-1/2 -translate-y-1/2 bg-gray-300 text-white p-2 rounded-lg transition-colors cursor-not-allowed';

                // 加载文件
                const response = await fetch(EXCEL_FILE_PATH);
                if (!response.ok) throw new Error(`文件加载失败：${response.status} ${response.statusText}`);
                
                // 解析Excel
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                // 校验列
                if (jsonData.length === 0) throw new Error('Excel文件中无数据');
                const requiredCols = ['关键词', '内容'];
                const hasRequired = requiredCols.every(col => col in jsonData[0]);
                if (!hasRequired) throw new Error('Excel缺少必要列：关键词/内容');

                // 存储数据
                excelData = jsonData;
                const dataLen = excelData.length;

                // 更新状态
                dataCount.innerHTML = `<i class="fa fa-check text-green-500 mr-2"></i>已加载 ${dataLen} 条数据`;
                searchTip.textContent = `已加载 ${dataLen} 条数据，支持搜索关键词`;
                searchTip.className = 'text-center text-green-600 mt-2 text-sm';
                
                // 启用搜索
                searchInput.disabled = false;
                searchBtn.disabled = false;
                searchBtn.className = 'absolute right-3 top-1/2 -translate-y-1/2 bg-primary hover:bg-primary/90 text-white p-2 rounded-lg transition-colors';
                searchInput.focus();

            } catch (err) {
                console.error('加载失败：', err);
                dataCount.innerHTML = `<i class="fa fa-exclamation-circle text-red-500 mr-2"></i>数据加载失败`;
                searchTip.textContent = '数据加载失败，请检查文件后重试';
                searchTip.className = 'text-center text-red-600 mt-2 text-sm';
                errorDetail.textContent = err.message;
                loadError.classList.remove('hidden');
                excelData = [];
            }
        }

        // 核心搜索函数（简化逻辑，确保结果显示）
        function performSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                alert('请输入搜索关键词');
                searchInput.focus();
                return;
            }

            // 清空旧结果
            resultsContainer.innerHTML = '';
            resultsSection.classList.remove('hidden');
            noResults.classList.add('hidden');

            // 模糊搜索（关键词/内容列）
            const lowerKeyword = keyword.toLowerCase();
            const matchedData = excelData.filter(item => {
                const kw = (item.关键词 || '').toString().toLowerCase();
                const content = (item.内容 || '').toString().toLowerCase();
                return kw.includes(lowerKeyword) || content.includes(lowerKeyword);
            });

            // 更新结果计数
            resultCount.textContent = `${matchedData.length} 条结果`;

            // 无结果
            if (matchedData.length === 0) {
                noResults.classList.remove('hidden');
                return;
            }

            // 生成结果卡片（简化DOM生成逻辑）
            matchedData.forEach((item, index) => {
                const kw = item.关键词 || '未命名';
                const content = item.内容 || '';
                const remark = item.备注 || '';
                const isPureUrl = isValidUrl(content);

                // 处理高亮和链接
                const highlightedKw = highlightKeyword(kw, keyword);
                let contentHtml = textToClickableLinks(content);
                // 对非链接部分的关键词高亮（避免破坏a标签）
                if (!isPureUrl) {
                    // 先拆分链接和文本，只高亮文本部分
                    contentHtml = contentHtml.replace(/(<a.*?<\/a>)/gi, '|||$1|||').split('|||').map(part => {
                        if (part.startsWith('<a') && part.endsWith('</a>')) {
                            return part;
                        } else {
                            return highlightKeyword(part, keyword);
                        }
                    }).join('');
                }

                // 创建卡片DOM
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm p-4 card-hover border border-gray-100';
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="bg-primary/10 text-primary text-xs py-1 px-2 rounded-full">${index + 1}</span>
                        ${isPureUrl ? `<a href="${content}" target="_blank" class="text-gray-400 hover:text-primary" title="新窗口打开"><i class="fa fa-external-link"></i></a>` : ''}
                    </div>
                    <div class="mb-2">
                        <span class="text-xs text-gray-500">关键词：</span>
                        <span class="font-medium text-gray-800">${highlightedKw}</span>
                    </div>
                    <div class="mb-3">
                        <span class="text-xs text-gray-500">内容：</span>
                        <div class="text-sm text-gray-700 break-words mt-1">${contentHtml}</div>
                    </div>
                    ${remark ? `<div class="text-xs text-gray-500"><span class="text-gray-400">备注：</span>${remark}</div>` : ''}
                    ${isPureUrl ? `<a href="${content}" target="_blank" rel="noopener noreferrer" class="mt-2 inline-flex items-center text-sm bg-primary/5 text-primary py-1 px-3 rounded-lg hover:bg-primary/10">
                        <i class="fa fa-link mr-1.5"></i>访问链接
                    </a>` : ''}
                `;

                resultsContainer.appendChild(card);
            });

            // 滚动到结果区
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 事件绑定
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => e.key === 'Enter' && performSearch());
        reloadBtn.addEventListener('click', loadExcelData);

        // 页面加载时初始化
        window.addEventListener('DOMContentLoaded', () => {
            loadExcelData();
            // 调试用：打印数据加载状态
            console.log('页面加载完成，开始读取Excel数据');
        });
    </script>
</body>
</html>